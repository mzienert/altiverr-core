{
  "version": 3,
  "sources": ["../asset-input/src/functions/auth/manage-session/index.ts"],
  "sourcesContent": ["import { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';\n\ninterface CookieOptions {\n    httpOnly?: boolean;\n    secure?: boolean;\n    sameSite?: 'strict' | 'lax' | 'none';\n    maxAge?: number;\n    domain?: string;\n    path?: string;\n}\n\ntype APIGatewayProxyResultWithMultiValueHeaders = Omit<APIGatewayProxyResult, 'headers'> & {\n    multiValueHeaders?: { [header: string]: string[] };\n    headers: { [header: string]: string | number | boolean | string[] };\n};\n\nexport const handler = async (event: APIGatewayProxyEvent): Promise<APIGatewayProxyResultWithMultiValueHeaders> => {\n    console.log('Lambda started');\n    console.log('Event:', JSON.stringify(event, null, 2));\n\n    const corsHeaders = {\n        'Access-Control-Allow-Origin': 'https://www.asaracing.live',\n        'Access-Control-Allow-Credentials': 'true',\n        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\n        'Access-Control-Allow-Headers': 'Content-Type',\n    };\n\n    process.on('uncaughtException', (err) => {\n        console.error('Uncaught Exception:', err);\n    });\n\n    process.on('unhandledRejection', (err) => {\n        console.error('Unhandled Rejection:', err);\n    });\n\n    try {\n        // Handle OPTIONS preflight request\n        if (event.httpMethod === 'OPTIONS') {\n            return {\n                statusCode: 200,\n                headers: corsHeaders,\n                body: ''\n            };\n        }\n\n        // Handle verify request (GET)\n        if (event.httpMethod === 'GET') {\n            // Get the access token from cookies\n            const cookies = event.headers.Cookie || '';\n            const accessToken = cookies.split(';')\n                .find(cookie => cookie.trim().startsWith('accessToken='))\n                ?.split('=')[1];\n\n            if (!accessToken) {\n                return {\n                    statusCode: 401,\n                    headers: corsHeaders,\n                    body: JSON.stringify({ message: 'No access token found' })\n                };\n            }\n\n            return {\n                statusCode: 200,\n                headers: corsHeaders,\n                body: JSON.stringify({ valid: true })\n            };\n        }\n\n        // Handle POST request for session creation\n        if (event.httpMethod === 'POST' && event.resource === '/auth/manage-session') {\n            const body = JSON.parse(event.body || '{}');\n            const { accessToken, idToken } = body;\n\n            if (!accessToken || !idToken) {\n                return {\n                    statusCode: 400,\n                    headers: corsHeaders,\n                    body: JSON.stringify({ message: 'Missing required tokens' })\n                };\n            }\n\n            // Set cookies with proper security flags\n            const cookies = [\n                `accessToken=${accessToken}; Domain=.asaracing.live; Path=/; Secure; SameSite=None`,\n                `idToken=${idToken}; Domain=.asaracing.live; Path=/; Secure; SameSite=None`\n            ];\n\n            return {\n                statusCode: 200,\n                headers: {\n                  'Set-Cookie': [\n                    `accessToken=${accessToken}; Domain=.asaracing.live; Path=/; Secure; SameSite=None`,\n                    `idToken=${idToken}; Domain=.asaracing.live; Path=/; Secure; SameSite=None`\n                  ]\n                },\n                body: JSON.stringify({ success: true })\n            };\n        }\n\n        // Handle session creation (POST)\n        if (!event.body) {\n            return {\n                statusCode: 400,\n                headers: corsHeaders,\n                body: JSON.stringify({ message: 'Missing request body' })\n            };\n        }\n\n        const { accessToken, idToken } = JSON.parse(event.body);\n        if (!accessToken || !idToken) {\n            return {\n                statusCode: 400,\n                headers: corsHeaders,\n                body: JSON.stringify({ message: 'Missing required tokens' })\n            };\n        }\n\n        // Set cookies\n        return {\n            statusCode: 200,\n            headers: {\n                'Access-Control-Allow-Origin': 'https://www.asaracing.live',\n                'Access-Control-Allow-Methods': 'GET,POST,OPTIONS',\n                'Access-Control-Allow-Headers': 'Content-Type,Authorization,Origin,Access-Control-Request-Method,Access-Control-Request-Headers',\n                'Access-Control-Allow-Credentials': 'true',\n                'Access-Control-Max-Age': '300',\n                'Set-Cookie': [\n                    `accessToken=${accessToken}; HttpOnly; Secure; Path=/; SameSite=None; Max-Age=3600`,\n                    `idToken=${idToken}; HttpOnly; Secure; Path=/; SameSite=None; Max-Age=3600`\n                ].join('; ')\n            },\n            body: JSON.stringify({ success: true })\n        };\n\n    } catch (error) {\n        console.error('Error in handler:', error);\n        return {\n            statusCode: 500,\n            headers: corsHeaders,\n            body: JSON.stringify({ \n                message: 'Internal server error',\n                error: error instanceof Error ? error.message : String(error)\n            })\n        };\n    } finally {\n        console.log('Lambda finished');\n    }\n};\n\nfunction parseCookies(cookieString: string) {\n    return cookieString.split(';')\n        .map(cookie => cookie.trim())\n        .reduce((acc, cookie) => {\n            const [key, value] = cookie.split('=');\n            acc[key] = value;\n            return acc;\n        }, {} as Record<string, string>);\n}"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAgBO,IAAME,EAAU,MAAOE,GAAqF,CAC/G,QAAQ,IAAI,gBAAgB,EAC5B,QAAQ,IAAI,SAAU,KAAK,UAAUA,EAAO,KAAM,CAAC,CAAC,EAEpD,IAAMC,EAAc,CAChB,8BAA+B,6BAC/B,mCAAoC,OACpC,+BAAgC,qBAChC,+BAAgC,cACpC,EAEA,QAAQ,GAAG,oBAAsBC,GAAQ,CACrC,QAAQ,MAAM,sBAAuBA,CAAG,CAC5C,CAAC,EAED,QAAQ,GAAG,qBAAuBA,GAAQ,CACtC,QAAQ,MAAM,uBAAwBA,CAAG,CAC7C,CAAC,EAED,GAAI,CAEA,GAAIF,EAAM,aAAe,UACrB,MAAO,CACH,WAAY,IACZ,QAASC,EACT,KAAM,EACV,EAIJ,GAAID,EAAM,aAAe,MAOrB,OALgBA,EAAM,QAAQ,QAAU,IACZ,MAAM,GAAG,EAChC,KAAKG,GAAUA,EAAO,KAAK,EAAE,WAAW,cAAc,CAAC,GACtD,MAAM,GAAG,EAAE,CAAC,EAUX,CACH,WAAY,IACZ,QAASF,EACT,KAAM,KAAK,UAAU,CAAE,MAAO,EAAK,CAAC,CACxC,EAXW,CACH,WAAY,IACZ,QAASA,EACT,KAAM,KAAK,UAAU,CAAE,QAAS,uBAAwB,CAAC,CAC7D,EAWR,GAAID,EAAM,aAAe,QAAUA,EAAM,WAAa,uBAAwB,CAC1E,IAAMI,EAAO,KAAK,MAAMJ,EAAM,MAAQ,IAAI,EACpC,CAAE,YAAAK,EAAa,QAAAC,CAAQ,EAAIF,EAEjC,GAAI,CAACC,GAAe,CAACC,EACjB,MAAO,CACH,WAAY,IACZ,QAASL,EACT,KAAM,KAAK,UAAU,CAAE,QAAS,yBAA0B,CAAC,CAC/D,EAIJ,IAAMM,EAAU,CACZ,eAAeF,CAAW,0DAC1B,WAAWC,CAAO,yDACtB,EAEA,MAAO,CACH,WAAY,IACZ,QAAS,CACP,aAAc,CACZ,eAAeD,CAAW,0DAC1B,WAAWC,CAAO,yDACpB,CACF,EACA,KAAM,KAAK,UAAU,CAAE,QAAS,EAAK,CAAC,CAC1C,CACJ,CAGA,GAAI,CAACN,EAAM,KACP,MAAO,CACH,WAAY,IACZ,QAASC,EACT,KAAM,KAAK,UAAU,CAAE,QAAS,sBAAuB,CAAC,CAC5D,EAGJ,GAAM,CAAE,YAAAI,EAAa,QAAAC,CAAQ,EAAI,KAAK,MAAMN,EAAM,IAAI,EACtD,MAAI,CAACK,GAAe,CAACC,EACV,CACH,WAAY,IACZ,QAASL,EACT,KAAM,KAAK,UAAU,CAAE,QAAS,yBAA0B,CAAC,CAC/D,EAIG,CACH,WAAY,IACZ,QAAS,CACL,8BAA+B,6BAC/B,+BAAgC,mBAChC,+BAAgC,iGAChC,mCAAoC,OACpC,yBAA0B,MAC1B,aAAc,CACV,eAAeI,CAAW,0DAC1B,WAAWC,CAAO,yDACtB,EAAE,KAAK,IAAI,CACf,EACA,KAAM,KAAK,UAAU,CAAE,QAAS,EAAK,CAAC,CAC1C,CAEJ,OAASE,EAAO,CACZ,eAAQ,MAAM,oBAAqBA,CAAK,EACjC,CACH,WAAY,IACZ,QAASP,EACT,KAAM,KAAK,UAAU,CACjB,QAAS,wBACT,MAAOO,aAAiB,MAAQA,EAAM,QAAU,OAAOA,CAAK,CAChE,CAAC,CACL,CACJ,QAAE,CACE,QAAQ,IAAI,iBAAiB,CACjC,CACJ",
  "names": ["manage_session_exports", "__export", "handler", "__toCommonJS", "event", "corsHeaders", "err", "cookie", "body", "accessToken", "idToken", "cookies", "error"]
}
